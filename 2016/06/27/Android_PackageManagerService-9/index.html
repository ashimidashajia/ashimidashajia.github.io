<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android-6.0之PMS安装APK下篇 | 码农故事</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="安装一个apk分为：检查权限，复制文件，装在应用。前面分析了前两步，现在开始分析app的装载。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android-6.0之PMS安装APK下篇">
<meta property="og:url" content="http://www.iloveandroid.net/2016/06/27/Android_PackageManagerService-9/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="安装一个apk分为：检查权限，复制文件，装在应用。前面分析了前两步，现在开始分析app的装载。">
<meta property="og:image" content="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-11.png">
<meta property="og:updated_time" content="2016-06-29T03:05:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android-6.0之PMS安装APK下篇">
<meta name="twitter:description" content="安装一个apk分为：检查权限，复制文件，装在应用。前面分析了前两步，现在开始分析app的装载。">
  
    <link rel="alternative" href="/atom.xml" title="码农故事" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xj6ce.com1.z0.glb.clouddn.com/android.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">genglei.cuan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不断成长的见证</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/categories/linux基础">linux基础</a></li>
				        
							<li><a href="/categories/Android底层开发">Android底层开发</a></li>
				        
							<li><a href="/categories/App开发">App开发</a></li>
				        
							<li><a href="/categories/项目管理">项目管理</a></li>
				        
							<li><a href="/categories/Python">Python</a></li>
				        
							<li><a href="/categories/开源框架">开源框架</a></li>
				        
							<li><a href="/categories/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android刷机/" style="font-size: 10px;">Android刷机</a> <a href="/tags/Android底层/" style="font-size: 10px;">Android底层</a> <a href="/tags/Android核心服务/" style="font-size: 20px;">Android核心服务</a> <a href="/tags/Android编译/" style="font-size: 11.43px;">Android编译</a> <a href="/tags/Gradle/" style="font-size: 15.71px;">Gradle</a> <a href="/tags/linux常用命令/" style="font-size: 10px;">linux常用命令</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/代码管理/" style="font-size: 18.57px;">代码管理</a> <a href="/tags/应用开发/" style="font-size: 10px;">应用开发</a> <a href="/tags/提高效率/" style="font-size: 10px;">提高效率</a> <a href="/tags/构建/" style="font-size: 15.71px;">构建</a> <a href="/tags/签名认证/" style="font-size: 11.43px;">签名认证</a> <a href="/tags/自动化测试/" style="font-size: 14.29px;">自动化测试</a> <a href="/tags/调试/" style="font-size: 12.86px;">调试</a> <a href="/tags/逆向工程/" style="font-size: 17.14px;">逆向工程</a> <a href="/tags/逆向开发/" style="font-size: 18.57px;">逆向开发</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">码农的成长之路，不要让昨日的悲伤，浪费今天的眼泪。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">genglei.cuan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xj6ce.com1.z0.glb.clouddn.com/android.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">genglei.cuan</h1>
			</hgroup>
			
			<p class="header-subtitle">不断成长的见证</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/linux基础">linux基础</a></li>
		        
					<li><a href="/categories/Android底层开发">Android底层开发</a></li>
		        
					<li><a href="/categories/App开发">App开发</a></li>
		        
					<li><a href="/categories/项目管理">项目管理</a></li>
		        
					<li><a href="/categories/Python">Python</a></li>
		        
					<li><a href="/categories/开源框架">开源框架</a></li>
		        
					<li><a href="/categories/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Android_PackageManagerService-9" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/27/Android_PackageManagerService-9/" class="article-date">
  	<time datetime="2016-06-27T10:24:26.000Z" itemprop="datePublished">2016-06-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android-6.0之PMS安装APK下篇
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android核心服务/">Android核心服务</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android底层开发/">Android底层开发</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>安装一个apk分为：检查权限，复制文件，装在应用。前面分析了前两步，现在开始分析app的装载。</p>
<a id="more"></a>
<p>这一步中主要完成将dex转换为ART虚拟机的oat格式的执行文件，并为应用创建数据沙箱目录，最后把应用的信息装载进PMS的数据结构中去。</p>
<p>在前面的处理MCS_BOUND时调用的HandlerParams的startCopy方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">boolean</span> res;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">    ...........................</span><br><span class="line">               <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">        ....................................................</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   handleStartCopy();</span><br><span class="line">                   res = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">..............................</span><br><span class="line">           &#125;</span><br><span class="line">           handleReturnCode();</span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>可以知道当复制完文件之后，会调用InstallParams的handleReturnCode方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleReturnCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">// If mArgs is null, then MCS couldn't be reached. When it</span></span><br><span class="line">           <span class="comment">// reconnects, it will try again to install. At that point, this</span></span><br><span class="line">           <span class="comment">// will succeed.</span></span><br><span class="line">           <span class="keyword">if</span> (mArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">               processPendingInstall(mArgs, mRet);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">       mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               mHandler.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// Result object to be returned</span></span><br><span class="line">               PackageInstalledInfo res = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">               res.returnCode = currentStatus;</span><br><span class="line">               res.uid = -<span class="number">1</span>;</span><br><span class="line">               res.pkg = <span class="keyword">null</span>;</span><br><span class="line">               res.removedInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">               <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    <span class="comment">//一般情况下，什么都不会做的</span></span><br><span class="line">                   args.doPreInstall(res.returnCode);</span><br><span class="line">                   <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                       installPackageLI(args, res);</span><br><span class="line">                   &#125;</span><br><span class="line">                   args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">               &#125;</span><br><span class="line">            .....................................</span><br><span class="line">            <span class="comment">/* 省略关于云备份的代码*/</span></span><br><span class="line">            .....................................</span><br><span class="line">               <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                   <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                   <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                   <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"No restore - queue post-install for "</span> + token);</span><br><span class="line">                   Message msg = mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                   mHandler.sendMessage(msg);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>processPendingInstall()方法中post了一个消息，这样安装过程将以异步的方式继续执行。在post消息中，首先是调用installPackageLI()来装载应用，接下来的一大段代码是在执行设备备份操作，备份是通过BackupManagerService来完成的，这里就不分析了。备份完成之后，通过发送POST_INSTALL消息继续处理。</p>
<p>doPreInstall()一般情况下是什么都不会做的，接着看installPackageLI()方法，代码很长，所以依旧是以分段解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到installFlags，里面记录了app需要安装到哪里</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> installFlags = args.installFlags;</span><br><span class="line">        <span class="comment">// 安装程序的包名</span></span><br><span class="line">        <span class="keyword">final</span> String installerPackageName = args.installerPackageName;</span><br><span class="line">        <span class="comment">// 与sd卡安装有关，一般为null</span></span><br><span class="line">        <span class="keyword">final</span> String volumeUuid = args.volumeUuid;</span><br><span class="line">        <span class="comment">// 前面已经把apk拷贝到了临时阶段性文件夹/data/app/vmdl&lt;安装回话id&gt;.tmp/这个目录了</span></span><br><span class="line">        <span class="keyword">final</span> File tmpPackageFile = <span class="keyword">new</span> File(args.getCodePath());</span><br><span class="line">        <span class="comment">// 没有设定INSTALL_FORWARD_LOCK</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forwardLocked = ((installFlags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 是否安装到外部存储</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> onExternal = (((installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>)</span><br><span class="line">                || (args.volumeUuid != <span class="keyword">null</span>));</span><br><span class="line">        <span class="comment">// 初始化替换flag为假</span></span><br><span class="line">        <span class="keyword">boolean</span> replace = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 设置浏览参数</span></span><br><span class="line">        <span class="keyword">int</span> scanFlags = SCAN_NEW_INSTALL | SCAN_UPDATE_SIGNATURE;</span><br><span class="line">        <span class="comment">// 我们不是移动app，所以为null，不走这块代码</span></span><br><span class="line">        <span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// moving a complete application; perfom an initial scan on the new install location</span></span><br><span class="line">            scanFlags |= SCAN_INITIAL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化返回码</span></span><br><span class="line">        <span class="comment">// Result object to be returned</span></span><br><span class="line">        res.returnCode = PackageManager.INSTALL_SUCCEEDED;</span><br></pre></td></tr></table></figure>
<p>这里就是做了一些初始化值的工作。详情看上述注释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"installPackageLI: path="</span> + tmpPackageFile);</span><br><span class="line">      <span class="comment">// Retrieve PackageSettings and parse package</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置解析apk的flags</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> parseFlags = mDefParseFlags | PackageParser.PARSE_CHATTY</span><br><span class="line">              | (forwardLocked ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>)</span><br><span class="line">              | (onExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建一个解析器</span></span><br><span class="line">      PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">      pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">      <span class="comment">// 获得屏幕参数</span></span><br><span class="line">      pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 开始解析apk,要注意此时传入tmpPackageFile为一个文件夹</span></span><br><span class="line">          pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">          res.setError(<span class="string">"Failed parse during installPackageLI"</span>, e);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Mark that we have an install time CPU ABI override.</span></span><br><span class="line">      pkg.cpuAbiOverride = args.abiOverride;</span><br><span class="line"></span><br><span class="line">      String pkgName = res.name = pkg.packageName;</span><br><span class="line">      <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_TEST_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_ALLOW_TEST) == <span class="number">0</span>) &#123;</span><br><span class="line">              res.setError(INSTALL_FAILED_TEST_ONLY, <span class="string">"installPackageLI"</span>);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是解析APK，也就是解析AndroidMainifest.xml文件，将结果记录在PackageParser.Package中。前面已经详细介绍如何解析一个APK了，所以这里不在赘述了。</p>
<p>接下来是搜集apk的签名信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            pp.collectCertificates(pkg, parseFlags);</span><br><span class="line">            pp.collectManifestDigest(pkg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            res.setError(<span class="string">"Failed collect during installPackageLI"</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>如果安装程序此前传入了一个清单文件，那么将解析到的清单文件与传入的进行对比。安装器的确传入了一个清单，PackageInstallerActivity中也解析了apk,那时记录了这个清单，并一并传入到这里了。这里又做了一步判断，判断两者是同一个apk.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If the installer passed in a manifest digest, compare it now. */</span></span><br><span class="line">        <span class="keyword">if</span> (args.manifestDigest != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                <span class="keyword">final</span> String parsedManifest = pkg.manifestDigest == <span class="keyword">null</span> ? <span class="string">"null"</span></span><br><span class="line">                        : pkg.manifestDigest.toString();</span><br><span class="line">                Slog.d(TAG, <span class="string">"Comparing manifests: "</span> + args.manifestDigest.toString() + <span class="string">" vs. "</span></span><br><span class="line">                        + parsedManifest);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!args.manifestDigest.equals(pkg.manifestDigest)) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_PACKAGE_CHANGED, <span class="string">"Manifest digest changed"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            <span class="keyword">final</span> String parsedManifest = pkg.manifestDigest == <span class="keyword">null</span></span><br><span class="line">                    ? <span class="string">"null"</span> : pkg.manifestDigest.toString();</span><br><span class="line">            Slog.d(TAG, <span class="string">"manifestDigest was not present, but parser got: "</span> + parsedManifest);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>继续分析installPackageLI：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if installing already existing package</span></span><br><span class="line">            <span class="comment">// 如果安装已经存在的应用的时候，PackageInstaller应用安装器会在会在installFlags中设置INSTALL_REPLACE_EXISTING</span></span><br><span class="line">           <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 看看要替换的apk的包名是否存在原始包名</span></span><br><span class="line">                <span class="comment">// 当app升级导致前后包名不一致的时候，需要记录仍然是原始包名，</span></span><br><span class="line">                <span class="comment">// 所以这里要先检查要覆盖的app是否是这样的情况，是的话设置包名为旧的包名</span></span><br><span class="line">               String oldName = mSettings.mRenamedPackages.get(pkgName);</span><br><span class="line">               <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span></span><br><span class="line">                       &amp;&amp; pkg.mOriginalPackages.contains(oldName)</span><br><span class="line">                       &amp;&amp; mPackages.containsKey(oldName)) &#123;</span><br><span class="line">                   <span class="comment">// This package is derived from an original package,</span></span><br><span class="line">                   <span class="comment">// and this device has been updating from that original</span></span><br><span class="line">                   <span class="comment">// name.  We must continue using the original name, so</span></span><br><span class="line">                   <span class="comment">// rename the new package here.</span></span><br><span class="line">                   pkg.setPackageName(oldName);</span><br><span class="line">                   pkgName = pkg.packageName;</span><br><span class="line">                   replace = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replacing existing renamed package: oldName="</span></span><br><span class="line">                           + oldName + <span class="string">" pkgName="</span> + pkgName);</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPackages.containsKey(pkgName)) &#123;</span><br><span class="line">                   <span class="comment">// This package, under its official name, already exists</span></span><br><span class="line">                   <span class="comment">// on the device; we should replace it.</span></span><br><span class="line">                   replace = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replace existing pacakge: "</span> + pkgName);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Prevent apps opting out from runtime permissions</span></span><br><span class="line">               <span class="comment">// 检查新的app编译的时候选择的target目标版本低于6.0，而原来的app编译的时候target选择的是6.0，</span></span><br><span class="line">               <span class="comment">// 当一个app按照6.0来编译的话，需要按照6.0的规则来解析app的权限。</span></span><br><span class="line">               <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">                   PackageParser.Package oldPackage = mPackages.get(pkgName);</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> oldTargetSdk = oldPackage.applicationInfo.targetSdkVersion;</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> newTargetSdk = pkg.applicationInfo.targetSdkVersion;</span><br><span class="line">                   <span class="keyword">if</span> (oldTargetSdk &gt; Build.VERSION_CODES.LOLLIPOP_MR1</span><br><span class="line">                           &amp;&amp; newTargetSdk &lt;= Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                       res.setError(PackageManager.INSTALL_FAILED_PERMISSION_MODEL_DOWNGRADE,</span><br><span class="line">                               <span class="string">"Package "</span> + pkg.packageName + <span class="string">" new target SDK "</span> + newTargetSdk</span><br><span class="line">                                       + <span class="string">" doesn't support runtime permissions but the old"</span></span><br><span class="line">                                       + <span class="string">" target SDK "</span> + oldTargetSdk + <span class="string">" does."</span>);</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 如果ps不为null,同样说明，已经存在一个同包名的程序被安装，</span></span><br><span class="line">           <span class="comment">// 也就是还是处理覆盖安装的情况</span></span><br><span class="line">           <span class="comment">// 这里主要是验证包名的签名，不一致的话，是不能覆盖安装的，另外版本号也不能比安装的低，否则也不能安装</span></span><br><span class="line">           PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Existing package: "</span> + ps);</span><br><span class="line"></span><br><span class="line">              <span class="comment">// Quick sanity check that we're signed correctly if updating;</span></span><br><span class="line">              <span class="comment">// we'll check this again later when scanning, but we want to</span></span><br><span class="line">              <span class="comment">// bail early here before tripping over redefined permissions.</span></span><br><span class="line">              <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(ps, scanFlags)) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (!checkUpgradeKeySetLP(ps, pkg)) &#123;</span><br><span class="line">                      res.setError(INSTALL_FAILED_UPDATE_INCOMPATIBLE, <span class="string">"Package "</span></span><br><span class="line">                              + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                              + <span class="string">"previously installed version"</span>);</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      verifySignaturesLP(ps, pkg);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                      res.setError(e.error, e.getMessage());</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              oldCodePath = mSettings.mPackages.get(pkgName).codePathString;</span><br><span class="line">              <span class="keyword">if</span> (ps.pkg != <span class="keyword">null</span> &amp;&amp; ps.pkg.applicationInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  systemApp = (ps.pkg.applicationInfo.flags &amp;</span><br><span class="line">                          ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              res.origUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要是对覆盖安装的时候，设置一些变量。</p>
<p>继续分析，接下来是对apk定义的权限进行初步检查：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check whether the newly-scanned package wants to define an already-defined perm</span></span><br><span class="line">            <span class="keyword">int</span> N = pkg.permissions.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                PackageParser.Permission perm = pkg.permissions.get(i);</span><br><span class="line">                BasePermission bp = mSettings.mPermissions.get(perm.info.name);</span><br><span class="line">                <span class="keyword">if</span> (bp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If the defining package is signed with our cert, it's okay.  This</span></span><br><span class="line">                    <span class="comment">// also includes the "updating the same package" case, of course.</span></span><br><span class="line">                    <span class="comment">// "updating same package" could also involve key-rotation.</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> sigsOk;</span><br><span class="line">                    <span class="keyword">if</span> (bp.sourcePackage.equals(pkg.packageName)</span><br><span class="line">                            &amp;&amp; (bp.packageSetting <span class="keyword">instanceof</span> PackageSetting)</span><br><span class="line">                            &amp;&amp; (shouldCheckUpgradeKeySetLP((PackageSetting) bp.packageSetting,</span><br><span class="line">                                    scanFlags))) &#123;</span><br><span class="line">                        sigsOk = checkUpgradeKeySetLP((PackageSetting) bp.packageSetting, pkg);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sigsOk = compareSignatures(bp.packageSetting.signatures.mSignatures,</span><br><span class="line">                                pkg.mSignatures) == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!sigsOk) &#123;</span><br><span class="line">                        <span class="comment">// If the owning package is the system itself, we log but allow</span></span><br><span class="line">                        <span class="comment">// install to proceed; we fail the install on all other permission</span></span><br><span class="line">                        <span class="comment">// redefinitions.</span></span><br><span class="line">                        <span class="keyword">if</span> (!bp.sourcePackage.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                            res.setError(INSTALL_FAILED_DUPLICATE_PERMISSION, <span class="string">"Package "</span></span><br><span class="line">                                    + pkg.packageName + <span class="string">" attempting to redeclare permission "</span></span><br><span class="line">                                    + perm.info.name + <span class="string">" already owned by "</span> + bp.sourcePackage);</span><br><span class="line">                            res.origPermission = perm.info.name;</span><br><span class="line">                            res.origPackage = bp.sourcePackage;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                                    + <span class="string">" attempting to redeclare system permission "</span></span><br><span class="line">                                    + perm.info.name + <span class="string">"; ignoring new declaration"</span>);</span><br><span class="line">                            pkg.permissions.remove(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码作用是检查apk中定义的所有的权限是否已经被其他应用定义了，如果重定义的是系统应用定义的权限，那么忽略本app定义的这个权限。如果重定义的是非系统应用的权限，那么本次安装就以失败返回。</p>
<p>继续分析，当一个app是系统应用，但又希望安装在外部存储，那么就报错。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (systemApp &amp;&amp; onExternal) &#123;</span><br><span class="line">            <span class="comment">// Disable updates to system apps on sdcard</span></span><br><span class="line">            res.setError(INSTALL_FAILED_INVALID_INSTALL_LOCATION,</span><br><span class="line">                    <span class="string">"Cannot install updates to system apps on sdcard"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>意味着，系统app是不能安装到外部存储的。</p>
<p>继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们不是在移动app，所以不走这个分支</span></span><br><span class="line"><span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We did an in-place move, so dex is ready to roll</span></span><br><span class="line">    scanFlags |= SCAN_NO_DEX;</span><br><span class="line">    scanFlags |= SCAN_MOVE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_INTERNAL_ERROR,</span><br><span class="line">                    <span class="string">"Missing settings for moved package "</span> + pkgName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We moved the entire application as-is, so bring over the</span></span><br><span class="line">        <span class="comment">// previously derived ABI information.</span></span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = ps.primaryCpuAbiString;</span><br><span class="line">        pkg.applicationInfo.secondaryCpuAbi = ps.secondaryCpuAbiString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</span><br><span class="line">  <span class="comment">//走这个分支</span></span><br><span class="line">    <span class="comment">// Enable SCAN_NO_DEX flag to skip dexopt at a later stage</span></span><br><span class="line">    <span class="comment">// 设置SCAN_NO_DEX，这样在这个阶段就不会执行dexopt</span></span><br><span class="line">    scanFlags |= SCAN_NO_DEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        derivePackageAbi(pkg, <span class="keyword">new</span> File(pkg.codePath), args.abiOverride,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/* extract libs */</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException pme) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Error deriving application ABI"</span>, pme);</span><br><span class="line">        res.setError(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Error deriving application ABI"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run dexopt before old package gets removed, to minimize time when app is unavailable</span></span><br><span class="line">    <span class="keyword">int</span> result = mPackageDexOptimizer</span><br><span class="line">            .performDexOpt(pkg, <span class="keyword">null</span> <span class="comment">/* instruction sets */</span>, <span class="keyword">false</span> <span class="comment">/* forceDex */</span>,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/* defer */</span>, <span class="keyword">false</span> <span class="comment">/* inclDependencies */</span>);</span><br><span class="line">    <span class="keyword">if</span> (result == PackageDexOptimizer.DEX_OPT_FAILED) &#123;</span><br><span class="line">        res.setError(INSTALL_FAILED_DEXOPT, <span class="string">"Dexopt failed for "</span> + pkg.codePath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>derivePackageAbi()方法也很重要，主要完成了apk的so库路径设置，以及主次abi的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Derive the ABI of a non-system package located at &#123;<span class="doctag">@code</span> scanFile&#125;. This information</span><br><span class="line"> * is derived purely on the basis of the contents of &#123;<span class="doctag">@code</span> scanFile&#125; and</span><br><span class="line"> * &#123;<span class="doctag">@code</span> cpuAbiOverride&#125;.</span><br><span class="line"> *</span><br><span class="line"> * If &#123;<span class="doctag">@code</span> extractLibs&#125; is true, native libraries are extracted from the app if required.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">derivePackageAbi</span><span class="params">(PackageParser.Package pkg, File scanFile,</span><br><span class="line">                             String cpuAbiOverride, <span class="keyword">boolean</span> extractLibs)</span></span><br><span class="line">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="comment">//这里是第一次调用，主要确定pkg中的applicationInfo中的下面三个字段</span></span><br><span class="line">    <span class="comment">// nativeLibraryRootDir /data/app/vmdl&lt;回话id&gt;.tmp/lib</span></span><br><span class="line">    <span class="comment">// nativeLibraryRootRequiresIsa 为true,用户安装的第三方app，该字段就为true,说明需要在lib/加前缀，如arm,arm64等</span></span><br><span class="line">    <span class="comment">// nativeLibraryDir :/data/app/vmdl&lt;回话id&gt;.tmp/lib/&lt;前缀&gt;</span></span><br><span class="line"></span><br><span class="line">    setNativeLibraryPaths(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We would never need to extract libs for forward-locked and external packages,</span></span><br><span class="line">    <span class="comment">// since the container service will do it for us. We shouldn't attempt to</span></span><br><span class="line">    <span class="comment">// extract libs from system app when it was not updated.</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.isForwardLocked() || isExternal(pkg) ||</span><br><span class="line">        (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp()) ) &#123;</span><br><span class="line">        extractLibs = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String nativeLibraryRootStr = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line">    <span class="comment">// 对于用户安装的第三方app，该标志为true，预示着要在nativeLibraryRootStr路径后面加上“arm”或者”arm64"或者“x86”</span></span><br><span class="line">    <span class="comment">// 这类的前缀，具体原因请参考setNativeLibraryPaths()</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useIsaSpecificSubdirs = pkg.applicationInfo.nativeLibraryRootRequiresIsa;</span><br><span class="line"></span><br><span class="line">    NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        handle = NativeLibraryHelper.Handle.create(scanFile);</span><br><span class="line">        <span class="comment">// TODO(multiArch): This can be null for apps that didn't go through the</span></span><br><span class="line">        <span class="comment">// usual installation process. We can calculate it again, like we</span></span><br><span class="line">        <span class="comment">// do during install time.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// TODO(multiArch): Why do we need to rescan ASEC apps again ? It seems totally</span></span><br><span class="line">        <span class="comment">// unnecessary.</span></span><br><span class="line">        <span class="keyword">final</span> File nativeLibraryRoot = <span class="keyword">new</span> File(nativeLibraryRootStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Null out the abis so that they can be recalculated.</span></span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = <span class="keyword">null</span>;</span><br><span class="line">        pkg.applicationInfo.secondaryCpuAbi = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isMultiArch(pkg.applicationInfo)) &#123;</span><br><span class="line">            <span class="comment">// Warn if we've set an abiOverride for multi-lib packages..</span></span><br><span class="line">            <span class="comment">// By definition, we need to copy both 32 and 64 bit libraries for</span></span><br><span class="line">            <span class="comment">// such packages.</span></span><br><span class="line">            <span class="comment">// cpuAbiOverride对于有多个so库文件夹的apk是无效的</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.cpuAbiOverride != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !NativeLibraryHelper.CLEAR_ABI_OVERRIDE.equals(pkg.cpuAbiOverride)) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Ignoring abiOverride for multi arch application."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> abi32 = PackageManager.NO_NATIVE_LIBRARIES;</span><br><span class="line">            <span class="keyword">int</span> abi64 = PackageManager.NO_NATIVE_LIBRARIES;</span><br><span class="line">            <span class="keyword">if</span> (Build.SUPPORTED_32_BIT_ABIS.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (extractLibs) &#123;</span><br><span class="line">                  <span class="comment">// 这里再次拷贝，如果apk中的lib中的so库时间戳没有发生变化的时候，是不会在拷贝的，因为前面已经拷贝过了</span></span><br><span class="line">                  <span class="comment">// 只有当so库发生变化的时候，才会再次拷贝</span></span><br><span class="line">                    abi32 = NativeLibraryHelper.copyNativeBinariesForSupportedAbi(handle,</span><br><span class="line">                            nativeLibraryRoot, Build.SUPPORTED_32_BIT_ABIS,</span><br><span class="line">                            useIsaSpecificSubdirs);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    abi32 = NativeLibraryHelper.findSupportedAbi(handle, Build.SUPPORTED_32_BIT_ABIS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            maybeThrowExceptionForMultiArchCopy(</span><br><span class="line">                    <span class="string">"Error unpackaging 32 bit native libs for multiarch app."</span>, abi32);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Build.SUPPORTED_64_BIT_ABIS.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (extractLibs) &#123;</span><br><span class="line">                  <span class="comment">// 这里再次拷贝，如果apk中的lib中的so库时间戳没有发生变化的时候，是不会在拷贝的，因为前面已经拷贝过了</span></span><br><span class="line">                  <span class="comment">// 只有当so库发生变化的时候，才会再次拷贝</span></span><br><span class="line">                    abi64 = NativeLibraryHelper.copyNativeBinariesForSupportedAbi(handle,</span><br><span class="line">                            nativeLibraryRoot, Build.SUPPORTED_64_BIT_ABIS,</span><br><span class="line">                            useIsaSpecificSubdirs);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    abi64 = NativeLibraryHelper.findSupportedAbi(handle, Build.SUPPORTED_64_BIT_ABIS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            maybeThrowExceptionForMultiArchCopy(</span><br><span class="line">                    <span class="string">"Error unpackaging 64 bit native libs for multiarch app."</span>, abi64);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abi64 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果so库支持64位的abi,而且系统也是64位的话Message1</span></span><br><span class="line">                <span class="comment">// 就把主abi设置为ro.product.cpu.abilist64列表中abi64索引的值</span></span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi = Build.SUPPORTED_64_BIT_ABIS[abi64];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abi32 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> String abi = Build.SUPPORTED_32_BIT_ABIS[abi32];</span><br><span class="line">                <span class="keyword">if</span> (abi64 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 当系统是64位。且apk中即包含了64位的库，又包含了32位的库，</span></span><br><span class="line">                    <span class="comment">// 那么就把次abi设置为ro.product.cpu.abilist32列表中abi32索引的值</span></span><br><span class="line">                    pkg.applicationInfo.secondaryCpuAbi = abi;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果app只有32位的库，那么就把</span></span><br><span class="line">                    <span class="comment">// 主abi设置为ro.product.cpu.abilist32列表中abi32索引的值</span></span><br><span class="line">                    pkg.applicationInfo.primaryCpuAbi = abi;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//对于apk中的lib中只有一个so库文件夹，走这个分支</span></span><br><span class="line">           <span class="comment">// cpuAbiOverride传入的为null</span></span><br><span class="line">           <span class="comment">// 所以abiList为ro.product.cpu.abilist列表中的值</span></span><br><span class="line">            String[] abiList = (cpuAbiOverride != <span class="keyword">null</span>) ?</span><br><span class="line">                    <span class="keyword">new</span> String[] &#123; cpuAbiOverride &#125; : Build.SUPPORTED_ABIS;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Enable gross and lame hacks for apps that are built with old</span></span><br><span class="line">            <span class="comment">// SDK tools. We must scan their APKs for renderscript bitcode and</span></span><br><span class="line">            <span class="comment">// not launch them if it's present. Don't bother checking on devices</span></span><br><span class="line">            <span class="comment">// that don't have 64 bit support.</span></span><br><span class="line">            <span class="keyword">boolean</span> needsRenderScriptOverride = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (Build.SUPPORTED_64_BIT_ABIS.length &gt; <span class="number">0</span> &amp;&amp; cpuAbiOverride == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    NativeLibraryHelper.hasRenderscriptBitcode(handle)) &#123;</span><br><span class="line">                abiList = Build.SUPPORTED_32_BIT_ABIS;</span><br><span class="line">                needsRenderScriptOverride = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> copyRet;</span><br><span class="line">            <span class="keyword">if</span> (extractLibs) &#123;</span><br><span class="line">               <span class="comment">// 同样只有当so库发生变化时，才会再次拷贝</span></span><br><span class="line">                copyRet = NativeLibraryHelper.copyNativeBinariesForSupportedAbi(handle,</span><br><span class="line">                        nativeLibraryRoot, abiList, useIsaSpecificSubdirs);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                copyRet = NativeLibraryHelper.findSupportedAbi(handle, abiList);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (copyRet &lt; <span class="number">0</span> &amp;&amp; copyRet != PackageManager.NO_NATIVE_LIBRARIES) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR,</span><br><span class="line">                        <span class="string">"Error unpackaging native libs for app, errorCode="</span> + copyRet);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为只有一个so库文件夹，所以只需要设置主abi即可</span></span><br><span class="line">            <span class="keyword">if</span> (copyRet &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi = abiList[copyRet];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (copyRet == PackageManager.NO_Message1NATIVE_LIBRARIES &amp;&amp; cpuAbiOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi = cpuAbiOverride;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needsRenderScriptOverride) &#123;</span><br><span class="line">                pkg.Message1applicationInfo.primaryCpuAbi = abiList[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Unable to get canonical file "</span> + ioe.toString());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now that we've calculated the ABIs and determined if it's an internal app,</span></span><br><span class="line">    <span class="comment">// we will go ahead and populate the nativeLibraryPath.</span></span><br><span class="line">    <span class="comment">// 再次执行该方法，设置pkg中的applicationInfo的字段</span></span><br><span class="line">    <span class="comment">// secondaryNativeLibraryDir</span></span><br><span class="line">    setNativeLibraryPaths(pkg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来调用下面的代码进行了dexopt操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run dexopt before old package gets removed, to minimize time when app is unavailable</span></span><br><span class="line"><span class="keyword">int</span> result = mPackageDexOptimizer</span><br><span class="line">        .performDexOpt(pkg, <span class="keyword">null</span> <span class="comment">/* instruction sets */</span>, <span class="keyword">false</span> <span class="comment">/* forceDex */</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* defer */</span>, <span class="keyword">false</span> <span class="comment">/* inclDependencies */</span>);</span><br><span class="line"><span class="keyword">if</span> (result == PackageDexOptimizer.DEX_OPT_FAILED) &#123;</span><br><span class="line">    res.setError(INSTALL_FAILED_DEXOPT, <span class="string">"Dexopt failed for "</span> + pkg.codePath);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">performDexOpt</span><span class="params">(PackageParser.Package pkg, String[] instructionSets,</span><br><span class="line">        <span class="keyword">boolean</span> forceDex, <span class="keyword">boolean</span> defer, <span class="keyword">boolean</span> inclDependencies)</span> </span>&#123;</span><br><span class="line">    ArraySet&lt;String&gt; done;</span><br><span class="line">    <span class="keyword">if</span> (inclDependencies &amp;&amp; (pkg.usesLibraries != <span class="keyword">null</span> || pkg.usesOptionalLibraries != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        done = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">        done.add(pkg.packageName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 走这个分支</span></span><br><span class="line">        done = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackageManagerService.mInstallLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> useLock = mSystemReady;</span><br><span class="line">        <span class="keyword">if</span> (useLock) &#123;</span><br><span class="line">            mDexoptWakeLock.setWorkSource(<span class="keyword">new</span> WorkSource(pkg.applicationInfo.uid));</span><br><span class="line">            mDexoptWakeLock.acquire();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// -----------------调用下面的方法</span></span><br><span class="line">            <span class="keyword">return</span> performDexOptLI(pkg, instructionSets, forceDex, defer, done);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (useLock) &#123;</span><br><span class="line">                mDexoptWakeLock.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">performDexOptLI</span><span class="params">(PackageParser.Package pkg, String[] targetInstructionSets,</span><br><span class="line">          <span class="keyword">boolean</span> forceDex, <span class="keyword">boolean</span> defer, ArraySet&lt;String&gt; done)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  传入的targetInstructionSets为null</span></span><br><span class="line">      <span class="comment">//  所以instructionSets为前面设置pkg.applicationInfo的主次abi值</span></span><br><span class="line">      <span class="comment">// 如果没有so库，也就没有设置主次abi,这时以ro.product.cpu.abilist列表第一个值，获取isa</span></span><br><span class="line">      <span class="keyword">final</span> String[] instructionSets = targetInstructionSets != <span class="keyword">null</span> ?</span><br><span class="line">              targetInstructionSets : getAppDexInstructionSets(pkg.applicationInfo);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// done 为null。所以跳过</span></span><br><span class="line">      <span class="keyword">if</span> (done != <span class="keyword">null</span>) &#123;</span><br><span class="line">          done.add(pkg.packageName);</span><br><span class="line">          <span class="keyword">if</span> (pkg.usesLibraries != <span class="keyword">null</span>) &#123;</span><br><span class="line">              performDexOptLibsLI(pkg.usesLibraries, instructionSets, forceDex, defer, done);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (pkg.usesOptionalLibraries != <span class="keyword">null</span>) &#123;</span><br><span class="line">              performDexOptLibsLI(pkg.usesOptionalLibraries, instructionSets, forceDex, defer,</span><br><span class="line">                      done);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_HAS_CODE) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> DEX_OPT_SKIPPED;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> vmSafeMode = (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_VM_SAFE_MODE) != <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> debuggable = (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> List&lt;String&gt; paths = pkg.getAllCodePathsExcludingResourceOnly();</span><br><span class="line">      <span class="keyword">boolean</span> performedDexOpt = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// There are three basic cases here:</span></span><br><span class="line">      <span class="comment">// 1.) we need to dexopt, either because we are forced or it is needed</span></span><br><span class="line">      <span class="comment">// 2.) we are deferring a needed dexopt</span></span><br><span class="line">      <span class="comment">// 3.) we are skipping an unneeded dexopt</span></span><br><span class="line">      <span class="keyword">final</span> String[] dexCodeInstructionSets = getDexCodeInstructionSets(instructionSets);</span><br><span class="line">      <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!forceDex &amp;&amp; pkg.mDexOptPerformed.contains(dexCodeInstructionSet)) &#123;</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">int</span> dexoptNeeded;</span><br><span class="line">              <span class="keyword">if</span> (forceDex) &#123;</span><br><span class="line">                <span class="comment">// 为false,所以不走这里</span></span><br><span class="line">                  dexoptNeeded = DexFile.DEX2OAT_NEEDED;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 因为是在安装apk，所以getDexOptNeeded返回的是DEX2OAT_NEEDED</span></span><br><span class="line">                      dexoptNeeded = DexFile.getDexOptNeeded(path, pkg.packageName,</span><br><span class="line">                              dexCodeInstructionSet, defer);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                      Slog.w(TAG, <span class="string">"IOException reading apk: "</span> + path, ioe);</span><br><span class="line">                      <span class="keyword">return</span> DEX_OPT_FAILED;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (!forceDex &amp;&amp; defer &amp;&amp; dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                  <span class="comment">// We're deciding to defer a needed dexopt. Don't bother dexopting for other</span></span><br><span class="line">                  <span class="comment">// paths and instruction sets. We'll deal with them all together when we process</span></span><br><span class="line">                  <span class="comment">// our list of deferred dexopts.</span></span><br><span class="line">                  addPackageForDeferredDexopt(pkg);</span><br><span class="line">                  <span class="keyword">return</span> DEX_OPT_DEFERRED;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                  <span class="keyword">final</span> String dexoptType;</span><br><span class="line">                  String oatDir = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">if</span> (dexoptNeeded == DexFile.DEX2OAT_NEEDED) &#123;</span><br><span class="line">                      dexoptType = <span class="string">"dex2oat"</span>;</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 获取oat目录：/data/app/vmdl&lt;安装回话id&gt;.tmp/oat</span></span><br><span class="line">                          oatDir = createOatDirIfSupported(pkg, dexCodeInstructionSet);</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                          Slog.w(TAG, <span class="string">"Unable to create oatDir for package: "</span> + pkg.packageName);</span><br><span class="line">                          <span class="keyword">return</span> DEX_OPT_FAILED;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dexoptNeeded == DexFile.PATCHOAT_NEEDED) &#123;</span><br><span class="line">                      dexoptType = <span class="string">"patchoat"</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dexoptNeeded == DexFile.SELF_PATCHOAT_NEEDED) &#123;</span><br><span class="line">                      dexoptType = <span class="string">"self patchoat"</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid dexopt needed: "</span> + dexoptNeeded);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 开始执行dex2oat</span></span><br><span class="line">                  Log.i(TAG, <span class="string">"Running dexopt ("</span> + dexoptType + <span class="string">") on: "</span> + path + <span class="string">" pkg="</span></span><br><span class="line">                          + pkg.applicationInfo.packageName + <span class="string">" isa="</span> + dexCodeInstructionSet</span><br><span class="line">                          + <span class="string">" vmSafeMode="</span> + vmSafeMode + <span class="string">" debuggable="</span> + debuggable</span><br><span class="line">                          + <span class="string">" oatDir = "</span> + oatDir);</span><br><span class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> sharedGid = UserHandle.getSharedAppGid(pkg.applicationInfo.uid);</span><br><span class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> ret = mPackageManagerService.mInstaller.dexopt(path, sharedGid,</span><br><span class="line">                          !pkg.isForwardLocked(), pkg.packageName, dexCodeInstructionSet,</span><br><span class="line">                          dexoptNeeded, vmSafeMode, debuggable, oatDir);</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// Dex2oat might fail due to compiler / verifier errors. We soldier on</span></span><br><span class="line">                  <span class="comment">// regardless, and attempt to interpret the app as a safety net.</span></span><br><span class="line">                  <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                      performedDexOpt = <span class="keyword">true</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;    </span><br><span class="line">          pkg.mDexOptPerformed.add(dexCodeInstructionSet);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> performedDexOpt ? DEX_OPT_PERFORMED : DEX_OPT_SKIPPED;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里执行dexopt实际上是在执行dex2oat，用来将apk中的dex文件转换为oat文件。值得注意的是，Android 6.0之前生成的oat文件都在</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/dalvik_cache/</span><br></pre></td></tr></table></figure>
<p>文件夹中，从Android 6.0 开始这个文件夹中只存放系统内置应用的oat文件，用户安装的app的oat文件在，最终会在</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/&#21253;&#21517;/oat/&#60;isa&#62;/</span><br></pre></td></tr></table></figure>
<p>继续分析installPackageLI：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, <span class="string">"Failed rename"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码作用从名字上就很清楚了:重命名。就是将<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/vmdl&#60;&#23433;&#35013;&#20250;&#35805;id&#62;.tmp</span><br></pre></td></tr></table></figure></p>
<p>重名为<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/&#21253;&#21517;-suffix</span><br></pre></td></tr></table></figure></p>
<p>suffix为1,2…….</p>
<p>同时更新pkg中的受影响的字段。</p>
<p>继续分析installPackageLI：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">        <span class="comment">// 如果是覆盖安装，则走这里</span></span><br><span class="line">          replacePackageLI(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</span><br><span class="line">                  installerPackageName, volumeUuid, res);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 初次安装，走这里</span></span><br><span class="line">          installNewPackageLI(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</span><br><span class="line">                  args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">          <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">              res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installNewPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span><br><span class="line">        UserHandle user, String installerPackageName, String volumeUuid,</span><br><span class="line">        PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Remember this for later, in case we need to rollback this install</span></span><br><span class="line">    String pkgName = pkg.packageName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"installNewPackageLI: "</span> + pkg);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dataDirExists = Environment</span><br><span class="line">            .getDataUserPackageDirectory(volumeUuid, UserHandle.USER_OWNER, pkgName).exists();</span><br><span class="line">    <span class="keyword">synchronized</span>(mPackages) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否构成升级关系</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.mRenamedPackages.containsKey(pkgName)) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, <span class="string">"Attempt to re-install "</span> + pkgName</span><br><span class="line">                    + <span class="string">" without first uninstalling package running as "</span></span><br><span class="line">                    + mSettings.mRenamedPackages.get(pkgName));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 看是否已经安装了</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkgName)) &#123;</span><br><span class="line">            <span class="comment">// Don't allow installation over an existing package with the same name.</span></span><br><span class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, <span class="string">"Attempt to re-install "</span> + pkgName</span><br><span class="line">                    + <span class="string">" without first uninstalling."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 很熟悉了吧，这里又调用了scanPackageLI</span></span><br><span class="line">        PackageParser.Package newPackage = scanPackageLI(pkg, parseFlags, scanFlags,</span><br><span class="line">                System.currentTimeMillis(), user);</span><br><span class="line"></span><br><span class="line">        updateSettingsLI(newPackage, installerPackageName, volumeUuid, <span class="keyword">null</span>, <span class="keyword">null</span>, res, user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res.returnCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line"></span><br><span class="line">            deletePackageLI(pkgName, UserHandle.ALL, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    dataDirExists ? PackageManager.DELETE_KEEP_DATA : <span class="number">0</span>,</span><br><span class="line">                            res.removedInfo, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点又回到了scanPackageLI参数为Package的方法了。该方法内部又调用scanPackageDirtyLI方法,前面文章详细讲解过了，这里值贴出与用户安装app相关的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span><br><span class="line">            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">         ........................</span><br><span class="line">        <span class="keyword">if</span> ((parseFlags&amp;PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Only allow system apps to be flagged as core apps.</span></span><br><span class="line">            pkg.coreApp = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       .........................................</span><br><span class="line">        <span class="comment">// Initialize package source and resource directories</span></span><br><span class="line">        File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line">        File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">        SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">        PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line">        .............................................</span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">              .................................</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if we are renaming from an original package name.</span></span><br><span class="line">            PackageSetting origPackage = <span class="keyword">null</span>;</span><br><span class="line">            String realName = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">              ...............................</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ..................................</span><br><span class="line">            <span class="comment">// 很重要，在这个方法里面，给该apk分配了UID</span></span><br><span class="line">            <span class="comment">// 并且将一些信息记录当前用户的包状态文件：</span></span><br><span class="line">            <span class="comment">// /data/system/users/userid/package-restrictions.xml</span></span><br><span class="line">            <span class="comment">// 不如当前app是否被隐藏，或者禁用，以及当前app哪些组件被禁用等。</span></span><br><span class="line">            pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                    destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                    pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                    pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                    pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                    user, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">"Creating application package "</span> + pkg.packageName + <span class="string">" failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          .................................</span><br><span class="line">            pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">            pkg.mExtras = pkgSetting;</span><br><span class="line">          .....................................</span><br><span class="line">        <span class="comment">//检查安装的app与已经安装的app定义的组件是否冲突</span></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                    ...................................</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ....................................</span><br><span class="line">        <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = scanFile.lastModified();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forceDex = (scanFlags &amp; SCAN_FORCE_DEX) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//修改进程信息，如名字等</span></span><br><span class="line">        pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">                pkg.applicationInfo.packageName,</span><br><span class="line">                pkg.applicationInfo.processName,</span><br><span class="line">                pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        File dataPath;</span><br><span class="line">        <span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">          ....................................</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 开始创建数据沙箱目录</span></span><br><span class="line">            dataPath = Environment.getDataUserPackageDirectory(pkg.volumeUuid,</span><br><span class="line">                    UserHandle.USER_OWNER, pkg.packageName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> uidError = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (dataPath.exists()) &#123;</span><br><span class="line">              ..........................................</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              ...............</span><br><span class="line">              <span class="comment">// 调用守护进程installd来完成实际的创建工作</span></span><br><span class="line">              <span class="comment">// installd的install会创建"/data/data/包名",权限751，默认是给userid为0的用户使用</span></span><br><span class="line">              <span class="comment">// 其内部会调用installd的createUserData为每一个非0的系统用户都创建沙箱目录</span></span><br><span class="line">              <span class="comment">// /data/user/userid/包名 ，并设置权限751，chown设置为该用户的属主</span></span><br><span class="line">                <span class="keyword">int</span> ret = createDataDirsLI(pkg.volumeUuid, pkgName, pkg.applicationInfo.uid,</span><br><span class="line">                        pkg.applicationInfo.seinfo);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Error from installer</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                            <span class="string">"Unable to create data dirs [errorCode="</span> + ret + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              ............................................</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String path = scanFile.getPath();</span><br><span class="line">        <span class="keyword">final</span> String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) == <span class="number">0</span>) &#123;</span><br><span class="line">          ..........................................</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_MOVE) != <span class="number">0</span>) &#123;</span><br><span class="line">              .....................................</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">      .........................</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始创建so库文件的连接</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Linking native library dir for "</span> + path);<span class="comment">//========================================</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] userIds = sUserManager.getUserIds();</span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">          ................................</span><br><span class="line">            <span class="comment">//只有设置了主abi,且主abi的so库是32位的才进行软连接</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.primaryCpuAbi != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    !VMRuntime.is64BitAbi(pkg.applicationInfo.primaryCpuAbi)) &#123;</span><br><span class="line">                <span class="keyword">final</span> String nativeLibPath = pkg.applicationInfo.nativeLibraryDir;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> userId : userIds) &#123;</span><br><span class="line">                  <span class="comment">// 对该app在所有用户中的沙箱目录中创建lib指向/data/app/包名-suffix/lib/&lt;isa&gt;/的软连接</span></span><br><span class="line">                    <span class="keyword">if</span> (mInstaller.linkNativeLibraryDirectory(pkg.volumeUuid, pkg.packageName,</span><br><span class="line">                            nativeLibPath, userId) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR,</span><br><span class="line">                                <span class="string">"Failed linking native library dir (user="</span> + userId + <span class="string">")"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">        pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">        pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">        ...........................</span><br><span class="line">        pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line"></span><br><span class="line">      ..........................................</span><br><span class="line">      <span class="comment">// 将安装该apk是产生的PackageSetting对象pkgSetting，加入mSettings中的mPackages，以及也加入到PMS中的mPackages</span></span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// Add the new setting to mSettings</span></span><br><span class="line">            mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">            <span class="comment">// Add the new setting to mPackages</span></span><br><span class="line">            mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the package's KeySets to the global KeySetManagerService</span></span><br><span class="line">            ksms.addScannedPackageLPw(pkg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="comment">// 将安装的apk中的内容提供者加入到PMS中的mProviders</span></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">              ...................</span><br><span class="line">                mProviders.addProvider(p);</span><br><span class="line">            ..........................</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            N = pkg.services.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">              <span class="comment">// 将安装的apk中的service加入到PMS中的mServices</span></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            .......................</span><br><span class="line">                mServices.addService(s);</span><br><span class="line">            ......................</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 将安装的apk中的receivers加入到PMS中的mReceivers</span></span><br><span class="line">            N = pkg.receivers.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            .....................</span><br><span class="line">                mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">          ............</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            N = pkg.activities.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 将安装的apk中的activity加入到PMS中的mActivities</span></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ....................................</span><br><span class="line">                mActivities.addActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">            .............................</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            N = pkg.permissionGroups.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">                PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">                <span class="keyword">if</span> (cur == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mPermissionGroups.put(pg.info.name, pg);</span><br><span class="line">                .........................</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                .............................</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            N = pkg.permissions.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                ....................................</span><br><span class="line">                <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                    p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                .....................................</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              ....................</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                            BasePermission.TYPE_NORMAL);</span><br><span class="line">                    permissionMap.put(p.info.name, bp);</span><br><span class="line">                &#125;</span><br><span class="line">          ................................</span><br><span class="line">          <span class="comment">//设置instrumentation</span></span><br><span class="line">            N = pkg.instrumentation.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">                a.info.packageName = pkg.applicationInfo.packageName;</span><br><span class="line">              .................................</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                N = pkg.protectedBroadcasts.size();</span><br><span class="line">                <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">            ..............................</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从installPackageLI的重要执行过程如下图所示：</p>
<p><img src="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-11.png" alt=""></p>
<p>执行完installPackageLI之后，返回processPendingInstall方法中，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">       mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ...........................</span><br><span class="line">               <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    <span class="comment">//一般情况下，什么都不会做的</span></span><br><span class="line">                   args.doPreInstall(res.returnCode);</span><br><span class="line">                   <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                       installPackageLI(args, res);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// 安装失败时，删除/data/app/包名中的内容</span></span><br><span class="line">                   args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">               &#125;</span><br><span class="line">            .....................................</span><br><span class="line">            <span class="comment">/* 省略关于云备份的代码*/</span></span><br><span class="line">            .....................................</span><br><span class="line">               <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                   <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                   <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                   <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"No restore - queue post-install for "</span> + token);</span><br><span class="line">                   Message msg = mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                   mHandler.sendMessage(msg);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">接下来就是发送POST_INSTALL消息，该消息的处理主要就是在发送广播，应用安装完成之后要通知系统中的其他应用开始处理，比如在launcher需要增加app的图标等。等发完广播，安装也就结束了，最后通过最初安装是传入的安装观察者observer返回最初的调用者。</span><br><span class="line"></span><br><span class="line">发送的广播有</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. android.intent.action.PACKAGE_ADDED</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 覆盖安装时，还要发送:android.intent.extra.REPLACING</span><br><span class="line"></span><br><span class="line">代码如下：</span><br><span class="line"></span><br><span class="line">```<span class="function">java</span><br><span class="line"><span class="title">sendPackageBroadcast</span><span class="params">(Intent.ACTION_PACKAGE_ADDED,</span><br><span class="line">        packageName, extras, <span class="keyword">null</span>, <span class="keyword">null</span>, firstUsers)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> update = res.removedInfo.removedPackage != <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (update) &#123;</span><br><span class="line">    extras.putBoolean(Intent.EXTRA_REPLACING, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED,</span><br><span class="line">        packageName, extras, <span class="keyword">null</span>, <span class="keyword">null</span>, updateUsers);</span><br><span class="line"><span class="keyword">if</span> (update) &#123;</span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_PACKAGE_REPLACED,</span><br><span class="line">            packageName, extras, <span class="keyword">null</span>, <span class="keyword">null</span>, updateUsers);</span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_MY_PACKAGE_REPLACED,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, packageName, <span class="keyword">null</span>, updateUsers);</span><br><span class="line">    ................</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/06/26/Android_PackageManagerService-8/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android-6.0之PMS安装APK上篇</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Android_PackageManagerService-9" data-title="Android-6.0之PMS安装APK下篇" data-url="http://www.iloveandroid.net/2016/06/27/Android_PackageManagerService-9/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"iloveandroid"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 genglei.cuan
   <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256335558'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1256335558%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script> 
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>