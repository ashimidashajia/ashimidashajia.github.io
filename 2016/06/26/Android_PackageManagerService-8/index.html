<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android-6.0之PMS安装APK上篇 | 码农故事</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="现在开始正式分析Android如何安装一个APK.">
<meta property="og:type" content="article">
<meta property="og:title" content="Android-6.0之PMS安装APK上篇">
<meta property="og:url" content="http://www.iloveandroid.net/2016/06/26/Android_PackageManagerService-8/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="现在开始正式分析Android如何安装一个APK.">
<meta property="og:image" content="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-7.png">
<meta property="og:image" content="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-8.png">
<meta property="og:image" content="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-9.png">
<meta property="og:image" content="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-10.png">
<meta property="og:updated_time" content="2016-06-27T10:19:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android-6.0之PMS安装APK上篇">
<meta name="twitter:description" content="现在开始正式分析Android如何安装一个APK.">
  
    <link rel="alternative" href="/atom.xml" title="码农故事" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xj6ce.com1.z0.glb.clouddn.com/android.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">genglei.cuan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不断成长的见证</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/categories/linux基础">linux基础</a></li>
				        
							<li><a href="/categories/Android底层开发">Android底层开发</a></li>
				        
							<li><a href="/categories/App开发">App开发</a></li>
				        
							<li><a href="/categories/项目管理">项目管理</a></li>
				        
							<li><a href="/categories/Python">Python</a></li>
				        
							<li><a href="/categories/开源框架">开源框架</a></li>
				        
							<li><a href="/categories/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android刷机/" style="font-size: 10px;">Android刷机</a> <a href="/tags/Android底层/" style="font-size: 10px;">Android底层</a> <a href="/tags/Android核心服务/" style="font-size: 20px;">Android核心服务</a> <a href="/tags/Android编译/" style="font-size: 11.43px;">Android编译</a> <a href="/tags/Gradle/" style="font-size: 15.71px;">Gradle</a> <a href="/tags/linux常用命令/" style="font-size: 10px;">linux常用命令</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/代码管理/" style="font-size: 18.57px;">代码管理</a> <a href="/tags/应用开发/" style="font-size: 10px;">应用开发</a> <a href="/tags/提高效率/" style="font-size: 10px;">提高效率</a> <a href="/tags/构建/" style="font-size: 15.71px;">构建</a> <a href="/tags/签名认证/" style="font-size: 11.43px;">签名认证</a> <a href="/tags/自动化测试/" style="font-size: 14.29px;">自动化测试</a> <a href="/tags/调试/" style="font-size: 12.86px;">调试</a> <a href="/tags/逆向工程/" style="font-size: 17.14px;">逆向工程</a> <a href="/tags/逆向开发/" style="font-size: 18.57px;">逆向开发</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">码农的成长之路，不要让昨日的悲伤，浪费今天的眼泪。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">genglei.cuan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xj6ce.com1.z0.glb.clouddn.com/android.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">genglei.cuan</h1>
			</hgroup>
			
			<p class="header-subtitle">不断成长的见证</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/linux基础">linux基础</a></li>
		        
					<li><a href="/categories/Android底层开发">Android底层开发</a></li>
		        
					<li><a href="/categories/App开发">App开发</a></li>
		        
					<li><a href="/categories/项目管理">项目管理</a></li>
		        
					<li><a href="/categories/Python">Python</a></li>
		        
					<li><a href="/categories/开源框架">开源框架</a></li>
		        
					<li><a href="/categories/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Android_PackageManagerService-8" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/26/Android_PackageManagerService-8/" class="article-date">
  	<time datetime="2016-06-26T07:26:07.000Z" itemprop="datePublished">2016-06-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android-6.0之PMS安装APK上篇
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android核心服务/">Android核心服务</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android底层开发/">Android底层开发</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>现在开始正式分析Android如何安装一个APK.</p>
<a id="more"></a>
<p>当使用Intent安装一个Android存储中的一个apk文件时，实际上是调用Android系统一个内部应用packageinstaller来完成的。这个内置系统应用，会显示安装过程，自然也有界面了，大家应该非常熟悉了，无非就是显示一些进度条，此app有哪些权限，以及安装完成自后，是否打开等。</p>
<p>packageinstaller内部也是对PMS的调用，安装时，会先调用PMS相关接口，解析APK文件，也就是其AndroidMainifest.xml文件，这样就得到了该app的组件，权限，包名等信息。然后以包名为key,检查该app是否已经安装，安装的话，设置replace的flag.</p>
<p>如果是之前没安装过的，那么会弹出一个activity，显示该app有哪些权限，底部有两个Button:”取消”和“安装”。点击”安装”，就开始安装了。</p>
<p>如果该app之前安装过了，弹出的Activity中会提示：“你要安装此应用的新版本吗？。。。。”，最后还会罗列出新app相比已经安装在设备上的app的权限有哪些变化，比如新添加了哪些权限等等。底部同样会提供两个Button：”取消”和“安装”。点击”安装”，就开始安装了。</p>
<p>当点击”安装”button之后，实际上跳转到PackageInstaller的InstallAppProgress这个activity了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Android-6/frameworks/base/core/java/android/content/pm/InstallAppProgress.java</span><br></pre></td></tr></table></figure>
<p>实际上就是执行该activity的onCreate方法，该方法又调用initView方法，initView方法再次进行一系列判断并创建用于观察安装是否成功的观察者类PackageInstallObserver对象后，开始调用下面的方法，开始真正的安装过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pm.installPackageWithVerificationAndEncryption(mPackageURI, observer, installFlags,</span><br><span class="line">        installerPackageName, verificationParams, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>其代码实现：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Android6.0/frameworks/base/core/java/android/app/ApplicationPackageManager.java</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installPackageWithVerificationAndEncryption</span><span class="params">(Uri packageURI,</span><br><span class="line">        PackageInstallObserver observer, <span class="keyword">int</span> flags, String installerPackageName,</span><br><span class="line">        VerificationParams verificationParams, ContainerEncryptionParams encryptionParams)</span> </span>&#123;</span><br><span class="line">    installCommon(packageURI, observer, flags, installerPackageName, verificationParams,</span><br><span class="line">            encryptionParams);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内部直接又调用了installCommon方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installCommon</span><span class="params">(Uri packageURI,</span><br><span class="line">           PackageInstallObserver observer, <span class="keyword">int</span> flags, String installerPackageName,</span><br><span class="line">           VerificationParams verificationParams, ContainerEncryptionParams encryptionParams)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="string">"file"</span>.equals(packageURI.getScheme())) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Only file:// URIs are supported"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (encryptionParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ContainerEncryptionParams not supported"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> String originPath = packageURI.getPath();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           mPM.installPackage(originPath, observer.getBinder(), flags, installerPackageName,</span><br><span class="line">                   verificationParams, <span class="keyword">null</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>做了一系列判断后，接着调用mPM的installPackage方法。mPM就是PMS的一个代理。也就是说这里实际会调用PMS的installPackage方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installPackage</span><span class="params">(String originPath, IPackageInstallObserver2 observer,</span><br><span class="line">           <span class="keyword">int</span> installFlags, String installerPackageName, VerificationParams verificationParams,</span><br><span class="line">           String packageAbiOverride)</span> </span>&#123;</span><br><span class="line">       installPackageAsUser(originPath, observer, installFlags, installerPackageName,</span><br><span class="line">               verificationParams, packageAbiOverride, UserHandle.getCallingUserId());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>整个安装过程很复杂，大体上可分为两个过程：</p>
<ol>
<li><p>权限检查</p>
</li>
<li><p>复制文件</p>
</li>
<li><p>装载应用</p>
</li>
</ol>
<h3 id="权限检查">权限检查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installPackageAsUser</span><span class="params">(String originPath, IPackageInstallObserver2 observer,</span><br><span class="line">           <span class="keyword">int</span> installFlags, String installerPackageName, VerificationParams verificationParams,</span><br><span class="line">           String packageAbiOverride, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">       mContext.enforceCallingOrSelfPermission(android.Manifest.permission.INSTALL_PACKAGES, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 利用binder机制，获取安装发起进程的uid</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       enforceCrossUserPermission(callingUid, userId, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="string">"installPackageAsUser"</span>);</span><br><span class="line"></span><br><span class="line">       ..............................................</span><br></pre></td></tr></table></figure>
<p>先检查权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enforceCrossUserPermission</span><span class="params">(<span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> requireFullPermission,</span><br><span class="line">            <span class="keyword">boolean</span> checkShell, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid userId "</span> + userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//当前userid和发起者进程所属的userid一致，那么OK，直接返回</span></span><br><span class="line">        <span class="comment">// 我们现在就属于这种情况</span></span><br><span class="line">        <span class="keyword">if</span> (userId == UserHandle.getUserId(callingUid)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不一致，那就要看是不是SYSTEM进程了，依旧不是，那么执行下逻辑，抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (callingUid != Process.SYSTEM_UID &amp;&amp; callingUid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requireFullPermission) &#123;</span><br><span class="line">                mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                        android.Manifest.permission.INTERACT_ACROSS_USERS_FULL, message);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                            android.Manifest.permission.INTERACT_ACROSS_USERS_FULL, message);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException se) &#123;</span><br><span class="line">                    mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                            android.Manifest.permission.INTERACT_ACROSS_USERS, message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里的权限检查主要是检查进程是否有权限安装.</p>
<p>继续installPackageAsUser代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//检查当前系统用户是否具备安装app的权限</span></span><br><span class="line"> <span class="keyword">if</span> (isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">             observer.onPackageInstalled(<span class="string">""</span>, INSTALL_FAILED_USER_RESTRICTED, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//如果是发起端进程是shell或者root，那么添加flags:PackageManager.INSTALL_FROM_ADB</span></span><br><span class="line"> <span class="keyword">if</span> ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123;</span><br><span class="line">     installFlags |= PackageManager.INSTALL_FROM_ADB;</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// Caller holds INSTALL_PACKAGES permission, so we're less strict</span></span><br><span class="line">     <span class="comment">// about installerPackageName.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 从flags中去掉INSTALL_FROM_ADB和INSTALL_ALL_USERS</span></span><br><span class="line">     installFlags &amp;= ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">     installFlags &amp;= ~PackageManager.INSTALL_ALL_USERS;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//创建一个当前用户的handle</span></span><br><span class="line"> UserHandle user;</span><br><span class="line"> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_ALL_USERS) != <span class="number">0</span>) &#123;</span><br><span class="line">     user = UserHandle.ALL;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     user = <span class="keyword">new</span> UserHandle(userId);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Only system components can circumvent runtime permissions when installing.</span></span><br><span class="line"> <span class="comment">// Android 6.0 当权限属于运行时权限时，需要弹出框，让用户授权，对于system app，应该取消运行时权限弹框授权，而是直接授权。</span></span><br><span class="line"> <span class="comment">// 那么就要在system app中加入INSTALL_GRANT_RUNTIME_PERMISSIONS</span></span><br><span class="line"> <span class="comment">// 我们安装第三方app，当然没有INSTALL_GRANT_RUNTIME_PERMISSIONS了</span></span><br><span class="line"> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span></span><br><span class="line">         &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">         .INSTALL_GRANT_RUNTIME_PERMISSIONS) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"You need the "</span></span><br><span class="line">             + <span class="string">"android.permission.INSTALL_GRANT_RUNTIME_PERMISSIONS permission "</span></span><br><span class="line">             + <span class="string">"to use the PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS flag"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> verificationParams.setInstallerUid(callingUid);</span><br></pre></td></tr></table></figure>
<p>这里主要是对当前用户是否有权限安装app进行检查，以及安装的app是仅仅为当前用户安装，还是给所有的用户安装。从以上代码可以得出，当安装进程是shell或者root时，flags中又包含了INSTALL_ALL_USERS时，才会给所有用户安装，否则大多数情况下，仅仅安装给当前的用户。当我们使用pm命令安装的时候，可以选择安装给哪个用户，也可以是全部用户，就是这个原因。</p>
<p>继续installPackageAsUser代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> File originFile = <span class="keyword">new</span> File(originPath);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//后续判断APK安装到哪里时，会用到</span></span><br><span class="line">    <span class="keyword">final</span> OriginInfo origin = OriginInfo.fromUntrustedFile(originFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">    msg.obj = <span class="keyword">new</span> InstallParams(origin, <span class="keyword">null</span>, observer, installFlags, installerPackageName,</span><br><span class="line">            <span class="keyword">null</span>, verificationParams, user, packageAbiOverride, <span class="keyword">null</span>);</span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造InstallParams，然后利用Android中的Handler机制，发送给相关的线程进行安装。</p>
<p>installPackageAsUser整个执行逻辑如<img src="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-7.png" alt="">所示。</p>
<h3 id="复制文件">复制文件</h3><p>前面发送了INIT_COPY消息，现在看如何处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                    HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">                    <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"init_copy idx="</span> + idx + <span class="string">": "</span> + params);</span><br><span class="line">                    <span class="comment">// If a bind was already initiated we dont really</span></span><br><span class="line">                    <span class="comment">// need to do anything. The pending install</span></span><br><span class="line">                    <span class="comment">// will be processed later on.</span></span><br><span class="line">                    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                        <span class="comment">// If this is the only one pending we might</span></span><br><span class="line">                        <span class="comment">// have to bind to the service again.</span></span><br><span class="line">                        <span class="comment">// 将绑定DefaultContainerService服务</span></span><br><span class="line">                        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">                            params.serviceError();<span class="comment">//连接服务失败</span></span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Once we bind to the service, the first</span></span><br><span class="line">                            <span class="comment">// pending request will be processed.</span></span><br><span class="line">                            <span class="comment">// 连接成功，吧安装信息保存到mPendingInstalls中</span></span><br><span class="line">                            <span class="comment">// 等待收到连接的返回消息后，再继续安装</span></span><br><span class="line">                            mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 插入安装信息</span></span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        <span class="comment">// Already bound to the service. Just make</span></span><br><span class="line">                        <span class="comment">// sure we trigger off processing the first request.</span></span><br><span class="line">                        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//如果mPendingInstalls中只有一项，那么立即发送MCS_BOUND消息</span></span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ........</span><br></pre></td></tr></table></figure>
<p>INIT_COPY消息的处理中将绑定DefaultContainerService,因为这是一个异步的过程，要等待的绑定的结果通过onServiceConnected()返回，所以这里就将安装的参数信息放到了mPendingInstalls列表中，如果这个Service之前就绑定好了，现在就不要再次绑定了，安装信息同样要放到mPendingInstalls中。如果有多个安装请求同时到达，就可以通过mPendingInstalls列表对它们进行排队。如果列表中只有一项，说明没有更多的安装请求，因此这种情况下，需要立即发出MCS_BOUND消息，进入下一步的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connectToService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"Trying to bind to"</span> +</span><br><span class="line">                    <span class="string">" DefaultContainerService"</span>);</span><br><span class="line">            Intent service = <span class="keyword">new</span> Intent().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">            <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">                    Context.BIND_AUTO_CREATE, UserHandle.OWNER)) &#123;</span><br><span class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">                mBound = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title">ServiceConnection</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceConnected"</span>);</span><br><span class="line">           IMediaContainerService imcs =</span><br><span class="line">               IMediaContainerService.Stub.asInterface(service);</span><br><span class="line">           mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceDisconnected"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到当绑定成功后在onServiceConnected中将一个IBinder转换成了一个IMediaContainerService.这个就是在onServiceConnected回调函数中根据参数传进来的IMediaContainerService.Stub的对象引用创建的一个远程代理对象。以后PMS务通过该代理对象访问DefaultContainerService服务。它是一个应用服务。</p>
<p>整个INIT_COPY逻辑如<img src="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-8.png" alt="">所示。</p>
<p>接下来分析MCS_BOUND消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_BOUND:  &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_bound"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                            <span class="comment">// Something seriously wrong since we are not bound and we are not</span></span><br><span class="line">                            <span class="comment">// waiting for connection. Bail out.</span></span><br><span class="line">                            Slog.e(TAG, <span class="string">"Cannot bind to media container service"</span>);</span><br><span class="line">                            <span class="keyword">for</span> (HandlerParams params : mPendingInstalls) &#123;</span><br><span class="line">                                <span class="comment">// Indicate service bind error</span></span><br><span class="line">                                <span class="comment">// 连接失败，通过参数中的毁掉接口，通知调用者出错了</span></span><br><span class="line">                                params.serviceError();</span><br><span class="line">                            &#125;</span><br><span class="line">                            mPendingInstalls.clear();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Waiting to connect to media container service"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        HandlerParams params = mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (params.startCopy()) &#123;<span class="comment">//==============执行拷贝操作</span></span><br><span class="line">                                <span class="comment">// We are done...  look for more work or to</span></span><br><span class="line">                                <span class="comment">// go idle.</span></span><br><span class="line">                                <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                        <span class="string">"Checking for more work or unbind..."</span>);</span><br><span class="line">                                <span class="comment">// Delete pending install</span></span><br><span class="line">                                <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    mPendingInstalls.remove(<span class="number">0</span>);<span class="comment">//工作完成后，删除第一项</span></span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                                <span class="string">"Posting delayed MCS_UNBIND"</span>);</span><br><span class="line">                                        removeMessages(MCS_UNBIND);</span><br><span class="line">                                        Message ubmsg = obtainMessage(MCS_UNBIND);</span><br><span class="line">                                        <span class="comment">// Unbind after a little delay, to avoid</span></span><br><span class="line">                                        <span class="comment">// continual thrashing.</span></span><br><span class="line">                                        <span class="comment">// 如果没有安装信息了，则发送延时10秒的MCS_UNBIND消息</span></span><br><span class="line">                                        sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// There are more pending requests in queue.</span></span><br><span class="line">                                    <span class="comment">// Just post MCS_BOUND message to trigger processing</span></span><br><span class="line">                                    <span class="comment">// of next pending install.</span></span><br><span class="line">                                    <span class="comment">// 如果还有安装信息，则继续发送MCS_BOUND消息</span></span><br><span class="line">                                    <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                            <span class="string">"Posting MCS_BOUND for next work"</span>);</span><br><span class="line">                                    mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Should never happen ideally.</span></span><br><span class="line">                        Slog.w(TAG, <span class="string">"Empty queue"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<p>MCS_BOUND消息的处理过程就是调用InstallParams类的startCopy()方法来执行拷贝操作。只要mPendingInstalls中还有安装信息，就会重复发送MCS_BOUND消息，直到所有的应用都安装完毕，然后在发送一个延时10秒的MCS_UNBIND消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_UNBIND: &#123;</span><br><span class="line">                    <span class="comment">// If there is no actual work left, then time to unbind.</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_unbind"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span> &amp;&amp; mPendingVerification.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"calling disconnectService()"</span>);</span><br><span class="line"></span><br><span class="line">                            disconnectService();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// There are more pending requests in queue.</span></span><br><span class="line">                        <span class="comment">// Just post MCS_BOUND message to trigger processing</span></span><br><span class="line">                        <span class="comment">// of next pending install.</span></span><br><span class="line">                        mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<p>MCS_UNBIND消息的处理就简单了，当mPendingInstalls中没有安装信息的时候，就调用disconnectService断开与DefaultContainerService的连接。如果发现还有安装信息，则继续发送MCS_BOUND消息。</p>
<p>接下来分析真正的拷贝方法：startCopy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">boolean</span> res;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"startCopy "</span> + mUser + <span class="string">": "</span> + <span class="keyword">this</span>);</span><br><span class="line">              <span class="comment">// MAX_RETRIES为4</span></span><br><span class="line">               <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">                   Slog.w(TAG, <span class="string">"Failed to invoke remote methods on default container service. Giving up"</span>);</span><br><span class="line">                   mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">                   handleServiceError();</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   handleStartCopy();</span><br><span class="line">                   res = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Posting install MCS_RECONNECT"</span>);</span><br><span class="line">               mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">               res = <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           handleReturnCode();<span class="comment">//会尝试重新绑定</span></span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>startCopy()方法通过调用其子类InstallParams的handleStartCopy()来完成拷贝操作。考虑到安装过程的不确定性，startCopy主要工作是进行错误处理，当捕获到handleStartCopy跑出的异常时，startCopy将发送MCS_RECONNECT.在MCS_RECONNECT消息的处理中，将会重新绑定DefaultContainerService,如果绑定成功，那么安装过程将会重新开始。startCopy也将会再次被调用，重试的次数记录在mRetries中，当累计重试超过4次时，安装将失。如果安装失败，那么startCopy将会调用handleReturnCode()来继续处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">           <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If we're already staged, we've firmly committed to an install location</span></span><br><span class="line">           <span class="comment">// 这里staged为false,前面在创建origin时，传入的false</span></span><br><span class="line">           <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">               <span class="keyword">if</span> (origin.file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   installFlags |= PackageManager.INSTALL_INTERNAL;</span><br><span class="line">                   installFlags &amp;= ~PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origin.cid != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   installFlags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                   installFlags &amp;= ~PackageManager.INSTALL_INTERNAL;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid stage location"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 检查installFlags中是否有设置安装到哪里，我们这种情况下，是没有设置的，但是当通过pm命令安装的时候，是可以指定安装到哪里的</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> onInt = (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//精简版PackageInfo</span></span><br><span class="line">           PackageInfoLite pkgLite = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 如果即设置了安装在内部存储中又设置了安装在外部SD中，则报错</span></span><br><span class="line">           <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">               <span class="comment">// Check if both bits are set.</span></span><br><span class="line">               Slog.w(TAG, <span class="string">"Conflicting flags specified for installing on both internal and external"</span>);</span><br><span class="line">               ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags,</span><br><span class="line">                       packageAbiOverride);</span><br><span class="line"></span><br><span class="line">               <span class="comment">/*</span><br><span class="line">                * If we have too little free space, try to free cache</span><br><span class="line">                * before giving up.</span><br><span class="line">                */</span></span><br><span class="line">                <span class="comment">//检查存储空间是否够安装该app，不够的话，执行下面的分支</span></span><br><span class="line">               <span class="keyword">if</span> (!origin.staged &amp;&amp; pkgLite.recommendedInstallLocation</span><br><span class="line">                       == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">                   <span class="comment">// <span class="doctag">TODO:</span> focus freeing disk space on the target device</span></span><br><span class="line">                   <span class="keyword">final</span> StorageManager storage = StorageManager.from(mContext);</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">long</span> lowThreshold = storage.getStorageLowBytes(</span><br><span class="line">                           Environment.getDataDirectory());</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">long</span> sizeBytes = mContainerService.calculateInstalledSize(</span><br><span class="line">                           origin.resolvedPath, isForwardLocked(), packageAbiOverride);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//尝试释放一些cache空间</span></span><br><span class="line">                   <span class="keyword">if</span> (mInstaller.freeCache(<span class="keyword">null</span>, sizeBytes + lowThreshold) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                     <span class="comment">//然后重新获取PackageInfoLite</span></span><br><span class="line">                       pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath,</span><br><span class="line">                               installFlags, packageAbiOverride);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">/*</span><br><span class="line">                    * The cache free must have deleted the file we</span><br><span class="line">                    * downloaded to install.</span><br><span class="line">                    *</span><br><span class="line">                    * <span class="doctag">TODO:</span> fix the "freeCache" call to not delete</span><br><span class="line">                    *       the file we care about.</span><br><span class="line">                    */</span></span><br><span class="line">                   <span class="keyword">if</span> (pkgLite.recommendedInstallLocation</span><br><span class="line">                           == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                       pkgLite.recommendedInstallLocation</span><br><span class="line">                           = PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">               <span class="keyword">int</span> loc = pkgLite.recommendedInstallLocation;</span><br><span class="line">               <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_ALREADY_EXISTS;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHehandleStartCopylper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_APK) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_APK;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_MEDIA_UNAVAILABLE) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_MEDIA_UNAVAILABLE;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// Override with defaults if needed.</span></span><br><span class="line">                   loc = installLocationPolicy(pkgLite);</span><br><span class="line">                   <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_VERSION_DOWNGRADE) &#123;</span><br><span class="line">                       ret = PackageManager.INSTALL_FAILED_VERSION_DOWNGRADE;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!onSd &amp;&amp; !onInt) &#123;</span><br><span class="line">                       <span class="comment">// Override install location with flags</span></span><br><span class="line">                       <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">                           <span class="comment">// Set the flag to install on external media.</span></span><br><span class="line">                           installFlags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                           installFlags &amp;= ~PackageManager.INSTALL_INTERNAL;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="comment">// Make sure the flag for installing on external</span></span><br><span class="line">                           <span class="comment">// media is unset</span></span><br><span class="line">                           installFlags |= PackageManager.INSTALL_INTERNAL;</span><br><span class="line">                           installFlags &amp;= ~PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line">           mArgs = args;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                * ADB installs appear as UserHandle.USER_ALL, and can only be performed by</span><br><span class="line">                * UserHandle.USER_OWNER, so use the package verifier for UserHandle.USER_OWNER.</span><br><span class="line">                */</span></span><br><span class="line">               <span class="keyword">int</span> userIdentifier = getUser().getIdentifier();</span><br><span class="line">               <span class="keyword">if</span> (userIdentifier == UserHandle.USER_ALL</span><br><span class="line">                       &amp;&amp; ((installFlags &amp; PackageManager.INSTALL_FROM_ADB) != <span class="number">0</span>)) &#123;</span><br><span class="line">                   userIdentifier = UserHandle.USER_OWNER;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">/*</span><br><span class="line">                * Determine if we have any installed package verifiers. If we</span><br><span class="line">                * do, then we'll defer to them to verify the packages.</span><br><span class="line">                */</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> requiredUid = mRequiredVerifierPackage == <span class="keyword">null</span> ? -<span class="number">1</span></span><br><span class="line">                       : getPackageUid(mRequiredVerifierPackage, userIdentifier);</span><br><span class="line">               <span class="keyword">if</span> (!origin.existing &amp;&amp; requiredUid != -<span class="number">1</span></span><br><span class="line">                       &amp;&amp; isVerificationEnabled(userIdentifier, installFlags)) &#123;</span><br><span class="line">                   <span class="comment">//此处是进行校验，具体校验什么没有深究，因为其发送的这个</span></span><br><span class="line">                   <span class="comment">//android.intent.action.PACKAGE_NEEDS_VERIFICATION</span></span><br><span class="line">                   <span class="comment">// 我没找到谁来处理它</span></span><br><span class="line">                   ..................................</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">/*</span><br><span class="line">                    * No package verification is enabled, so immediately start</span><br><span class="line">                    * the remote call to initiate copy using temporary file.</span><br><span class="line">                    */</span></span><br><span class="line">                   ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           mRet = ret;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>handleStartCopy()方法会判断该app应该安装到哪里，如果安装空间不足的话，会尝试在清理一些cache空间后，再次尝试安装。该方法中很多代码是在将一些信息通过发送Intent android.intent.action.PACKAGE_NEEDS_VERIFICATION 给系统中所有接收该Intent进行处理，但是很遗憾，我没找到处理这个Intent的东东。如果不需要校验的话，就直接调用InstallArgs的copyApk()方法。</p>
<p>该方法整个逻辑如<img src="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-9.png" alt="">所示。</p>
<p>再分析copyApk之前，先看InstallParams和InstallArgs之间的关系：</p>
<p><img src="http://7xj6ce.com1.z0.glb.clouddn.com/PMS-10.png" alt=""></p>
<p>createInstallArgs传入的params,在本例中就是InstallParams，在它的handleStartCopy()中已经确定了安装在哪里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallArgs <span class="title">createInstallArgs</span><span class="params">(InstallParams params)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (params.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 移动app</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> MoveInstallArgs(params);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installOnExternalAsec(params.installFlags) || params.isForwardLocked()) &#123;</span><br><span class="line">        <span class="comment">// 安装在SD</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> AsecInstallArgs(params);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 安装在内部存储</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> FileInstallArgs(params);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>本例中是安装在内部存储的，所以创建的就是FileInstallArgs了，那么调用的copyApk，自然就是FileInstallArgs的了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">              <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, origin.file + <span class="string">" already staged; skipping copy"</span>);</span><br><span class="line">              codeFile = origin.file;</span><br><span class="line">              resourceFile = origin.file;</span><br><span class="line">              <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">final</span> File tempDir = mInstallerService.allocateStageDirLegacy(volumeUuid);</span><br><span class="line">              codeFile = tempDir;</span><br><span class="line">              resourceFile = tempDir;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Failed to create copy file: "</span> + e);</span><br><span class="line">              <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">          &#125;</span><br><span class="line">  ............</span><br></pre></td></tr></table></figure>
<p>allocateStageDirLegacy:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> File <span class="title">allocateStageDirLegacy</span><span class="params">(String volumeUuid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 分配本次安装会话的ID</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> sessionId = allocateSessionIdLocked();</span><br><span class="line">                mLegacySessions.put(sessionId, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 得到一个本次安装的阶段性文件夹，后续会改名</span></span><br><span class="line">                <span class="keyword">final</span> File stageDir = buildStageDir(volumeUuid, sessionId);</span><br><span class="line">                prepareStageDir(stageDir);</span><br><span class="line">                <span class="keyword">return</span> stageDir;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> File <span class="title">buildStageDir</span><span class="params">(String volumeUuid, <span class="keyword">int</span> sessionId)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">final</span> File stagingDir = buildStagingDir(volumeUuid);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> File(stagingDir, <span class="string">"vmdl"</span> + sessionId + <span class="string">".tmp"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> File <span class="title">buildStagingDir</span><span class="params">(String volumeUuid)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> Environment.getDataAppDirectory(volumeUuid);</span><br><span class="line">          &#125;</span><br><span class="line">      <span class="comment">// volumeUuid一般为null</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getDataDirectory</span><span class="params">(String volumeUuid)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (TextUtils.isEmpty(volumeUuid)) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> File(<span class="string">"/data"</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> File(<span class="string">"/mnt/expand/"</span> + volumeUuid);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getDataAppDirectory</span><span class="params">(String volumeUuid)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> File(getDataDirectory(volumeUuid), <span class="string">"app"</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>buildStageDir方法执行后得到了路径字符串：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/vmdl&#60;&#22238;&#35805;ID&#62;.tmp</span><br></pre></td></tr></table></figure>
<p>prepareStageDir将创建了这个文件夹，并设置了755权限。</p>
<p>继续分析copyApk：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> IParcelFileDescriptorFactory target = <span class="keyword">new</span> IParcelFileDescriptorFactory.Stub() &#123;</span><br><span class="line">               <span class="annotation">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">open</span><span class="params">(String name, <span class="keyword">int</span> mode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid filename: "</span> + name);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="keyword">final</span> File file = <span class="keyword">new</span> File(codeFile, name);</span><br><span class="line">                       <span class="keyword">final</span> FileDescriptor fd = Os.open(file.getAbsolutePath(),</span><br><span class="line">                               O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">                       Os.chmod(file.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">new</span> ParcelFileDescriptor(fd);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException(<span class="string">"Failed to open: "</span> + e.getMessage());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">           ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</span><br><span class="line">           <span class="keyword">if</span> (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">               Slog.e(TAG, <span class="string">"Failed to copy package"</span>);</span><br><span class="line">               <span class="keyword">return</span> ret;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>调用DefaultContainerService的copyPackage方法将要安装的apk拷贝到前面创建的目录中，并设置权限为644，执行到这里就把base.apk拷贝到</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/vmdl&#60;&#22238;&#35805;ID&#62;.tmp</span><br></pre></td></tr></table></figure>
<p>中，并设置权限为644了。</p>
<p>继续分析copyApk：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> File libraryRoot = <span class="keyword">new</span> File(codeFile, LIB_DIR_NAME);</span><br><span class="line">           NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               handle = NativeLibraryHelper.Handle.create(codeFile);</span><br><span class="line">               ret = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libraryRoot,</span><br><span class="line">                       abiOverride);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               Slog.e(TAG, <span class="string">"Copying native libraries failed"</span>, e);</span><br><span class="line">               ret = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               IoUtils.closeQuietly(handle);</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>执行成功后会把app的so拷贝到：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/vmdl&#60;&#22238;&#35805;ID&#62;.tmp/lib/arm/</span><br></pre></td></tr></table></figure>
<p>如果是x86，则arm替换为x86等。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/06/24/Android_PackageManagerService-7/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android-6.0之PMS安装APK前奏</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Android_PackageManagerService-8" data-title="Android-6.0之PMS安装APK上篇" data-url="http://www.iloveandroid.net/2016/06/26/Android_PackageManagerService-8/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"iloveandroid"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 genglei.cuan
   <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256335558'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1256335558%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script> 
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>